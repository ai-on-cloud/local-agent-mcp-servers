name: Release

on:
    push:
        tags: ["v*"]

permissions:
    contents: write
    id-token: write # Required for cosign keyless signing via OIDC

env:
    CARGO_TERM_COLOR: always

jobs:
    build-release:
        name: Build ${{ matrix.target }}
        runs-on: ${{ matrix.os }}
        timeout-minutes: 40
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      artifact: browser-server
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact: browser-server
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact: browser-server
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact: browser-server.exe

        steps:
            - uses: actions/checkout@v4

            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - uses: Swatinem/rust-cache@v2

            - name: Build release
              run: cargo build --release --locked --target ${{ matrix.target }} -p browser-server

            - name: Package (Unix)
              if: runner.os != 'Windows'
              run: |
                  cd target/${{ matrix.target }}/release
                  tar czf ../../../browser-server-${{ matrix.target }}.tar.gz ${{ matrix.artifact }}

            - name: Package (Windows zip)
              if: runner.os == 'Windows'
              run: |
                  cd target/${{ matrix.target }}/release
                  7z a ../../../browser-server-${{ matrix.target }}.zip ${{ matrix.artifact }}

            - name: Build MSI (Windows)
              if: runner.os == 'Windows'
              run: |
                  cargo install cargo-wix
                  cargo wix --no-build --nocapture -p browser-server --target ${{ matrix.target }}
              continue-on-error: true

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: browser-server-${{ matrix.target }}
                  path: |
                      browser-server-${{ matrix.target }}.*
                      target/wix/*.msi

    publish:
        name: Publish Release
        needs: build-release
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Generate SHA256 checksums
              run: |
                  cd artifacts
                  find . -type f \( -name '*.tar.gz' -o -name '*.zip' -o -name '*.msi' \) -exec sha256sum {} + | sed 's|  \./[^/]*/|  |' > SHA256SUMS
                  echo "Generated checksums:"
                  cat SHA256SUMS

            - name: Install cosign
              uses: sigstore/cosign-installer@v3

            - name: Sign artifacts with cosign (keyless)
              run: |
                  for file in artifacts/**/*; do
                    [ -f "$file" ] || continue
                    case "$file" in
                      *.tar.gz|*.zip|*.msi)
                        cosign sign-blob --yes \
                          --oidc-issuer=https://token.actions.githubusercontent.com \
                          --output-signature="${file}.sig" \
                          --output-certificate="${file}.pem" \
                          "$file"
                        ;;
                    esac
                  done

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  generate_release_notes: true
                  files: |
                      artifacts/**/*
                      artifacts/SHA256SUMS
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
